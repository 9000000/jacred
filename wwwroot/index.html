<!DOCTYPE html>
<html lang="ru" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="description"
    content="JacRed - Торрент агрегатор. Поиск торрентов по нескольким трекерам в BDRip и HDRip качестве" />
  <meta name="theme-color" content="#0a0a0f" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Поиск торрентов | JacRed</title>
  <link rel="icon" type="image/png" href="./img/jacred.png" />
  <link rel="icon" type="image/x-icon" href="./img/favicon.ico" />
  <link rel="apple-touch-icon" href="./img/icon-192.png" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="search" type="application/opensearchdescription+xml" title="JacRed" href="/opensearch.xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'] },
          animation: {
            'fade-in': 'fadeIn 0.2s ease-out',
            'slide-up': 'slideUp 0.25s ease-out',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(8px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
          }
        }
      }
    }
  </script>
  <style>
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .dark ::-webkit-scrollbar-track {
      background: #1f2937;
    }

    .dark ::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 5px;
    }

    .dark ::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }

    ::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    ::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .spinner {
      animation: spin 0.7s linear infinite;
    }

    .transition-ui,
    .transition-ui * {
      transition-property: background-color, border-color, color, fill, stroke, opacity, transform;
      transition-timing-function: cubic-bezier(0.25, 0.1, 0.25, 1);
      transition-duration: 100ms;
    }

    *:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    body {
      background-color: #0a0a0f;
      padding-top: env(safe-area-inset-top, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      transition-property: background-color;
      transition-timing-function: cubic-bezier(0.25, 0.1, 0.25, 1);
      transition-duration: 100ms;
    }

    :root:not(.dark) body {
      background-color: #f9fafb;
    }

    .collapse-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
    }

    .collapse-content.show {
      max-height: 2200px;
      transition: max-height 0.25s ease-in;
    }

    @keyframes blinker {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    .blink {
      animation: blinker 1s linear infinite;
    }

    @media (max-width: 640px) {

      input,
      select,
      button:not(.btn-copy-magnet) {
        min-height: 44px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      #app {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
      }

      input,
      select,
      button {
        min-height: 44px;
        font-size: 16px;
      }

      #filterContainer label {
        font-size: 0.875rem;
      }
    }

    .tap-target {
      min-height: 44px;
      min-width: 44px;
    }

    button,
    a.magneto,
    .btn-copy-magnet {
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .toolbar-field {
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .dark .toolbar-field {
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 767px) {
      #app {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }

      #resultsDiv .webResult .h2 {
        flex-direction: column;
        align-items: flex-start;
      }

      #resultsDiv .webResult .h2 .magneto+.btn-copy-magnet {
        margin-top: 0;
      }
    }

    @media (min-width: 768px) {
      #filterContainer.show {
        max-height: 1800px;
      }
    }

    .line-clamp-1 {
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 1;
      line-clamp: 1;
    }

    .line-clamp-2 {
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      line-clamp: 2;
    }

    #resultsDiv .webResult .h2 .magneto,
    #resultsDiv .webResult .h2 .btn-copy-magnet,
    #resultsDiv .webResult .h2 .btn-copy-hash,
    #resultsDiv .webResult .h2 .btn-send-to-tor {
      border: 1px solid transparent;
      transition: transform 0.15s ease, box-shadow 0.2s ease, background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    #resultsDiv .webResult .h2 .magneto:active,
    #resultsDiv .webResult .h2 .btn-copy-magnet:active,
    #resultsDiv .webResult .h2 .btn-copy-hash:active,
    #resultsDiv .webResult .h2 .btn-send-to-tor:active {
      transform: scale(0.92);
    }

    #resultsDiv .webResult .h2 .magneto {
      border-color: rgba(255, 255, 255, 0.25);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
    }

    #resultsDiv .webResult .h2 .magneto:hover {
      border-color: rgba(255, 255, 255, 0.4);
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.35);
    }

    #resultsDiv .webResult .h2 .magneto:active {
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    #resultsDiv .webResult .h2 .btn-copy-magnet,
    #resultsDiv .webResult .h2 .btn-copy-hash,
    #resultsDiv .webResult .h2 .btn-send-to-tor {
      border-color: rgba(0, 0, 0, 0.06);
    }

    .dark #resultsDiv .webResult .h2 .btn-copy-magnet,
    .dark #resultsDiv .webResult .h2 .btn-copy-hash,
    .dark #resultsDiv .webResult .h2 .btn-send-to-tor {
      border-color: rgba(255, 255, 255, 0.08);
    }

    #resultsDiv .webResult .h2 .btn-copy-magnet:hover,
    #resultsDiv .webResult .h2 .btn-copy-hash:hover,
    #resultsDiv .webResult .h2 .btn-send-to-tor:hover {
      border-color: transparent;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }

    .dark #resultsDiv .webResult .h2 .btn-copy-magnet:hover,
    .dark #resultsDiv .webResult .h2 .btn-copy-hash:hover,
    .dark #resultsDiv .webResult .h2 .btn-send-to-tor:hover {
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
    }

    #resultsDiv .webResult .h2 .btn-copy-magnet:active,
    #resultsDiv .webResult .h2 .btn-copy-hash:active,
    #resultsDiv .webResult .h2 .btn-send-to-tor:active {
      box-shadow: none;
    }

    #resultsDiv .webResult .h2 .btn-send-to-tor.is-loading {
      cursor: wait;
    }

    #resultsDiv .webResult .h2 .btn-send-to-tor.is-sent {
      background-color: rgb(16 185 129) !important;
      border-color: transparent;
      color: #fff;
    }

    .dark #resultsDiv .webResult .h2 .btn-send-to-tor.is-sent {
      background-color: rgb(16 185 129) !important;
    }

    #backToTop {
      bottom: calc(1.5rem + env(safe-area-inset-bottom, 0px));
      right: calc(1rem + env(safe-area-inset-right, 0px));
    }
  </style>
</head>

<body class="text-gray-900 dark:text-gray-100 font-sans min-h-screen antialiased">
  <div id="app" class="transition-ui container mx-auto px-3 sm:px-4 py-3 sm:py-5 max-w-5xl">
    <noscript>
      <p
        class="rounded-xl bg-amber-100 dark:bg-amber-900/30 border border-amber-300 dark:border-amber-700 text-amber-800 dark:text-amber-200 px-4 py-3 mb-4">
        Для поиска торрентов необходим JavaScript. Включите его и обновите страницу.
      </p>
    </noscript>
    <main>
      <header class="mb-4 sm:mb-6 animate-slide-up">
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-3 sm:gap-4 min-w-0 flex-1">
            <a href="/"
              class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center bg-gradient-to-br from-red-500 via-red-600 to-amber-500 rounded-xl shadow-lg shadow-red-900/50"
              aria-label="На главную">
              <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </a>
            <div class="min-w-0">
              <h1
                class="text-xl sm:text-2xl font-bold bg-gradient-to-r from-red-400 to-amber-400 bg-clip-text text-transparent truncate">
                <span class="sm:hidden">Поиск</span><span class="hidden sm:inline">Поиск торрентов</span>
              </h1>
              <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 mt-0.5 hidden sm:block">По названию, КП или
                IMDB</p>
            </div>
          </div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <a href="/stats"
              class="tap-target inline-flex items-center justify-center gap-1.5 h-9 min-w-[44px] px-2.5 sm:px-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-medium no-underline transition-colors"
              aria-label="Статистика трекеров">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span class="hidden sm:inline">Статистика</span>
            </a>
            <button type="button" id="apiKeyBtn"
              class="tap-target inline-flex items-center justify-center gap-1.5 h-9 min-w-[44px] px-2.5 sm:px-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-medium transition-colors border border-transparent"
              aria-label="Установить API ключ" title="Установить API ключ">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
              </svg>
              <span class="hidden sm:inline">API ключ</span>
            </button>
            <button type="button" id="torServerBtn"
              class="tap-target inline-flex items-center justify-center gap-1.5 h-9 min-w-[44px] px-2.5 sm:px-3 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-medium transition-colors border border-transparent"
              aria-label="Настройки TorrServer" title="Настройки TorrServer">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
              </svg>
              <span class="hidden sm:inline">TorrServer</span>
            </button>
            <button id="toggleTheme"
              class="tap-target p-3 rounded-xl bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-700 transition-all group"
              aria-label="Переключить тему" type="button">
              <svg id="iconMoon"
                class="w-5 h-5 text-gray-600 dark:text-gray-400 group-hover:text-gray-800 dark:group-hover:text-gray-200"
                fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
              </svg>
              <svg id="iconSun" class="w-5 h-5 text-yellow-500 hidden" fill="none" stroke="currentColor"
                viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            </button>
          </div>
        </div>
      </header>

      <form id="searchForm"
        class="bg-white dark:bg-gray-900 rounded-2xl p-4 sm:p-5 border border-gray-200 dark:border-gray-800 shadow-sm mb-5 animate-slide-up toolbar-field">
        <div class="mb-4">
          <div class="relative">
            <input type="text" id="s" name="s"
              class="w-full px-4 py-3.5 pl-12 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
              placeholder="Введите название для поиска..." autocomplete="off" autofocus />
            <svg class="absolute left-4 top-4 w-5 h-5 text-gray-400 dark:text-gray-500 pointer-events-none" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <button type="button" id="clear"
              class="absolute right-3 top-3 p-1.5 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-all hidden"
              aria-label="Очистить">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div id="validateError" class="text-red-500 dark:text-red-400 text-sm mt-2 text-center blink hidden"
            role="alert" aria-live="assertive"></div>
        </div>

        <div class="mb-3">
          <button type="button" id="filterToggle" aria-expanded="false" aria-controls="filterContainer"
            class="tap-target w-full flex items-center justify-between px-3 sm:px-4 py-2 sm:py-2.5 min-h-[44px] bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-xl text-gray-900 dark:text-gray-100 font-medium transition-all">
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
              </svg>
              <span id="filterToggleLabel" class="text-sm sm:text-base">Дополнительные фильтры</span>
              <span id="filterCountBadge"
                class="hidden text-xs bg-blue-500 text-white px-1.5 py-0.5 rounded-full"></span>
            </span>
            <svg id="filterToggleIcon" class="w-4 h-4 sm:w-5 sm:h-5 shrink-0 transition-transform duration-150"
              fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
        </div>

        <div id="filterContainer" class="collapse-content" aria-hidden="true">
          <div
            class="mb-3 sm:mb-4 p-2.5 sm:p-3 lg:p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl space-y-2.5 sm:space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-2.5 lg:gap-3">
              <div>
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-1.5">Уточнить</label>
                <input name="refine" type="text" placeholder="Например BDRip, WEB-DL, США"
                  class="filter-input w-full px-2.5 sm:px-3 py-1.5 sm:py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500" />
              </div>
              <div>
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-1.5">Исключить</label>
                <input name="exclude" type="text" placeholder="Например HEVC"
                  class="filter-input w-full px-2.5 sm:px-3 py-1.5 sm:py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500" />
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-2.5 lg:gap-3">
              <div>
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-1.5">Качество</label>
                <select name="quality" aria-label="Качество"
                  class="filter-input w-full px-2.5 sm:px-3 py-1.5 sm:py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500">
                  <option value="">Любое</option>
                </select>
              </div>
              <div>
                <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-1.5">Тип
                  видео</label>
                <select name="videotype" aria-label="Тип видео"
                  class="filter-input w-full px-2.5 sm:px-3 py-1.5 sm:py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500">
                  <option value="">Любое</option>
                  <option value="sdr">SDR</option>
                  <option value="hdr">HDR</option>
                </select>
              </div>
              <div>
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-1.5">Озвучка</label>
                <select name="voice" aria-label="Озвучка"
                  class="filter-input w-full px-2.5 sm:px-3 py-1.5 sm:py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500">
                  <option value="">Любая</option>
                </select>
              </div>
              <div>
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-1.5">Сезон</label>
                <select name="season" aria-label="Сезон"
                  class="filter-input w-full px-2.5 sm:px-3 py-1.5 sm:py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500">
                  <option value="">Любой</option>
                </select>
              </div>
              <div>
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-1.5">Категория</label>
                <select name="type" aria-label="Категория"
                  class="filter-input w-full px-2.5 sm:px-3 py-1.5 sm:py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500">
                  <option value="">Любая</option>
                </select>
              </div>
              <div>
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-1.5">Трекер</label>
                <select name="tracker" aria-label="Трекер"
                  class="filter-input w-full px-2.5 sm:px-3 py-1.5 sm:py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500">
                  <option value="">Любой</option>
                </select>
              </div>
              <div>
                <label
                  class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-1.5">Год</label>
                <select name="year" aria-label="Год"
                  class="filter-input w-full px-2.5 sm:px-3 py-1.5 sm:py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500">
                  <option value="">Любой</option>
                </select>
              </div>
            </div>
            <div class="flex justify-end sm:justify-start pt-1">
              <button type="button" id="filterReset"
                class="px-3 sm:px-4 py-1.5 sm:py-2 bg-gray-700 dark:bg-gray-600 hover:bg-gray-800 dark:hover:bg-gray-700 text-white rounded-lg text-xs sm:text-sm font-medium transition-all">
                Сбросить фильтры
              </button>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 sm:gap-5 mb-4">
          <div class="flex flex-wrap items-center gap-2.5 sm:gap-4">
            <label
              class="flex items-center gap-2.5 cursor-pointer group min-h-[44px] sm:min-h-0 px-2 py-1.5 sm:px-0 sm:py-0 rounded-lg sm:rounded-none bg-gray-50 dark:bg-gray-800/50 sm:bg-transparent hover:bg-gray-100 dark:hover:bg-gray-700/50 sm:hover:bg-transparent transition-colors">
              <input type="radio" name="sort" value="sid" id="sortSid"
                class="w-5 h-5 sm:w-4 sm:h-4 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900 shrink-0 cursor-pointer"
                checked />
              <span
                class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-gray-100 select-none">по
                сидам</span>
            </label>
            <label
              class="flex items-center gap-2.5 cursor-pointer group min-h-[44px] sm:min-h-0 px-2 py-1.5 sm:px-0 sm:py-0 rounded-lg sm:rounded-none bg-gray-50 dark:bg-gray-800/50 sm:bg-transparent hover:bg-gray-100 dark:hover:bg-gray-700/50 sm:hover:bg-transparent transition-colors">
              <input type="radio" name="sort" value="size" id="sortSize"
                class="w-5 h-5 sm:w-4 sm:h-4 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900 shrink-0 cursor-pointer" />
              <span
                class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-gray-100 select-none">по
                размеру</span>
            </label>
            <label
              class="flex items-center gap-2.5 cursor-pointer group min-h-[44px] sm:min-h-0 px-2 py-1.5 sm:px-0 sm:py-0 rounded-lg sm:rounded-none bg-gray-50 dark:bg-gray-800/50 sm:bg-transparent hover:bg-gray-100 dark:hover:bg-gray-700/50 sm:hover:bg-transparent transition-colors">
              <input type="radio" name="sort" value="date" id="sortDate"
                class="w-5 h-5 sm:w-4 sm:h-4 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900 shrink-0 cursor-pointer" />
              <span
                class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-gray-100 select-none">по
                дате</span>
            </label>
            <label
              class="flex items-center gap-2.5 cursor-pointer group min-h-[44px] sm:min-h-0 px-2 py-1.5 sm:px-0 sm:py-0 rounded-lg sm:rounded-none bg-gray-50 dark:bg-gray-800/50 sm:bg-transparent hover:bg-gray-100 dark:hover:bg-gray-700/50 sm:hover:bg-transparent transition-colors">
              <input type="radio" name="sort" value="update" id="sortUpdate"
                class="w-5 h-5 sm:w-4 sm:h-4 text-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900 shrink-0 cursor-pointer" />
              <span
                class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-gray-100 select-none">по
                обновлению</span>
            </label>
          </div>
          <label
            class="flex items-center gap-2.5 cursor-pointer group min-h-[44px] sm:min-h-0 px-2 py-1.5 sm:px-0 sm:py-0 rounded-lg sm:rounded-none bg-gray-50 dark:bg-gray-800/50 sm:bg-transparent hover:bg-gray-100 dark:hover:bg-gray-700/50 sm:hover:bg-transparent transition-colors">
            <input type="checkbox" id="forcedSearch"
              class="w-5 h-5 sm:w-4 sm:h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-gray-900 shrink-0 cursor-pointer" />
            <span
              class="text-sm font-medium text-gray-700 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-gray-100 select-none">Точный
              поиск</span>
          </label>
        </div>

        <div class="flex gap-3 flex-wrap sm:flex-nowrap">
          <button type="submit" id="submitButton"
            class="flex-1 min-h-[48px] py-3.5 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold text-lg rounded-xl shadow-lg shadow-red-900/30 transition-all duration-150 hover:scale-[1.01] active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed tap-target">
            <span id="submitButtonText">ИСКАТЬ</span>
          </button>
          <button type="button" id="clearSearchStorage"
            class="min-h-[48px] px-4 py-3.5 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-medium rounded-xl transition-all tap-target shrink-0"
            title="Очистить сохранённый запрос и показать пустой поиск">
            Сбросить
          </button>
        </div>
      </form>

      <div id="loading" class="hidden text-center py-16 animate-fade-in">
        <div class="inline-flex flex-col items-center gap-4">
          <div class="w-16 h-16 border-4 border-gray-300 dark:border-gray-700 border-t-red-600 rounded-full spinner">
          </div>
          <p class="text-gray-600 dark:text-gray-400 font-medium text-lg">Поиск торрентов...</p>
        </div>
      </div>

      <div id="resultsDiv" class="animate-slide-up" aria-live="polite" aria-atomic="false"></div>

      <template id="helpTemplate">
        <div class="webResult help">
          <div
            class="bg-gradient-to-br from-blue-50 to-cyan-50 dark:from-blue-950/30 dark:to-cyan-950/30 rounded-2xl p-8 border border-blue-200 dark:border-blue-900/30 text-center">
            <svg class="w-16 h-16 text-blue-600 dark:text-blue-400 mx-auto mb-4" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Начните поиск</h3>
            <p class="text-gray-600 dark:text-gray-400">Введите название фильма или сериала, КП или IMDB для поиска по
              трекерам</p>
          </div>
        </div>
      </template>

      <template id="notfoundTemplate">
        <div class="webResult notfound">
          <div
            class="bg-white dark:bg-gray-900 rounded-2xl p-8 border border-gray-200 dark:border-gray-800 text-center">
            <svg class="w-16 h-16 text-gray-400 dark:text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Ничего не найдено</h3>
            <p class="text-gray-600 dark:text-gray-400">По вашему запросу результатов не обнаружено. Попробуйте изменить
              запрос или фильтры.</p>
          </div>
        </div>
      </template>

      <div id="loadMoreSentinel" class="text-center py-8">
        <div id="loadMoreIndicator" class="hidden inline-flex flex-col items-center gap-3">
          <div class="w-10 h-10 border-2 border-gray-300 dark:border-gray-700 border-t-red-600 rounded-full spinner">
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">Загрузка результатов...</p>
        </div>
      </div>
    </main>

    <footer class="mt-16 bg-white dark:bg-gray-900 rounded-2xl p-6 border border-gray-200 dark:border-gray-800">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="social flex items-center gap-3">
          <a href="https://github.com/jacred-fdb/jacred" target="_blank" rel="noopener noreferrer"
            class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            aria-label="GitHub">
            <i class="fab fa-github text-xl"></i>
          </a>
          <a href="https://t.me/pavelpikta" target="_blank" rel="noopener noreferrer"
            class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            aria-label="Telegram">
            <i class="fab fa-telegram text-xl"></i>
          </a>
        </div>
        <div class="text-sm text-gray-600 dark:text-gray-400">
          Работает на <a href="https://github.com/jacred-fdb/jacred" target="_blank" rel="noopener noreferrer"
            class="text-blue-600 dark:text-blue-400 hover:underline font-medium">Jacred</a>
        </div>
      </div>
    </footer>
  </div>

  <button id="backToTop"
    class="transition-ui fixed p-3 sm:p-4 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white rounded-full shadow-2xl shadow-red-900/50 opacity-0 pointer-events-none transition-all duration-150 z-50 group hover:scale-110 active:scale-95 tap-target"
    aria-label="Вернуться к началу страницы">
    <svg class="w-6 h-6 group-hover:-translate-y-0.5 transition-transform" fill="none" stroke="currentColor"
      viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
  </button>

  <div id="apiKeyModal" class="transition-ui fixed inset-0 z-[100] hidden" aria-modal="true"
    aria-labelledby="apiKeyModalTitle" role="dialog">
    <div class="absolute inset-0 bg-black/60 dark:bg-black/70 backdrop-blur-sm" id="apiKeyModalBackdrop"></div>
    <div class="relative flex min-h-full items-center justify-center p-4">
      <div
        class="w-full max-w-md rounded-2xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 shadow-2xl p-6 animate-fade-in">
        <h2 id="apiKeyModalTitle" class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">Установить API
          ключ</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Ключ используется для поиска по API. Сохраняется в
          браузере.</p>
        <input type="password" id="apiKeyInput" autocomplete="new-password"
          class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2"
          placeholder="Введите ключ API" />
        <p id="apiKeyModalError" class="text-sm text-red-500 dark:text-red-400 mb-4 hidden" role="alert"></p>
        <div class="flex gap-3 justify-end">
          <button type="button" id="apiKeyModalCancel"
            class="px-4 py-2.5 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Отмена</button>
          <button type="button" id="apiKeyModalSave"
            class="px-4 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium transition-colors">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <div id="torServerModal" class="transition-ui fixed inset-0 z-[100] hidden" aria-modal="true"
    aria-labelledby="torServerModalTitle" role="dialog">
    <div class="absolute inset-0 bg-black/60 dark:bg-black/70 backdrop-blur-sm" id="torServerModalBackdrop"></div>
    <div class="relative flex min-h-full items-center justify-center p-4">
      <div
        class="w-full max-w-md rounded-2xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 shadow-2xl p-6 animate-fade-in">
        <h2 id="torServerModalTitle" class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">Настройки
          TorrServer</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">URL TorrServer. При отправке с карточки торрента
          браузер отправляет POST с <strong>save_to_db: true</strong>. Настройки сохраняются в браузере (localStorage) и
          хранятся до тех пор, пока вы не очистите данные сайта или кэш.</p>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">URL сервера</label>
        <input type="url" id="torServerUrlInput" autocomplete="off"
          class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3"
          placeholder="http://my.torrserver.com" />
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Логин (необязательно)</label>
        <input type="text" id="torServerLoginInput" autocomplete="off"
          class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3"
          placeholder="Логин для Basic Auth" />
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Пароль (необязательно)</label>
        <input type="password" id="torServerPasswordInput" autocomplete="new-password"
          class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-xl text-gray-900 dark:text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
          placeholder="Пароль для Basic Auth" />
        <p id="torServerModalError" class="text-sm text-red-500 dark:text-red-400 mb-4 hidden" role="alert"></p>
        <div class="flex gap-3 justify-end">
          <button type="button" id="torServerModalCancel"
            class="px-4 py-2.5 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Отмена</button>
          <button type="button" id="torServerModalSave"
            class="px-4 py-2.5 rounded-xl bg-red-600 hover:bg-red-700 text-white font-medium transition-colors">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <script>
      (function () {
        'use strict';

        const LS = {
          get: (key) => { try { return localStorage.getItem(key) || ''; } catch (_) { return ''; } },
          set: (key, value) => { try { localStorage.setItem(key, value); } catch (e) { console.warn('localStorage.setItem(' + key + ') failed:', e); } },
          remove: (key) => { try { localStorage.removeItem(key); } catch (e) { console.warn('localStorage.removeItem(' + key + ') failed:', e); } }
        };

        const elements = {
          searchForm: null,
          searchInput: null,
          clear: null,
          submitButton: null,
          submitButtonText: null,
          validateError: null,
          loading: null,
          resultsDiv: null,
          filterToggle: null,
          filterToggleIcon: null,
          filterContainer: null,
          forcedSearch: null,
          toggleTheme: null,
          iconMoon: null,
          iconSun: null,
          backToTop: null
        };

        const PAGE_SIZE = 20;
        const API_BASE = '/api/v1.0';
        const FETCH_TIMEOUT_MS = 15000;
        const CONF_TIMEOUT_MS = 5000;

        const state = {
          isLoading: false,
          isLoadingMore: false,
          filtersVisible: false,
          allItems: [],
          filteredItems: [],
          displayCount: 0,
          currentQuery: '',
          filterRefine: '',
          filterExclude: ''
        };

        const debounce = (func, wait) => {
          let timeout;
          return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
          };
        };

        const getModalFocusables = (modal) => {
          if (!modal) return [];
          return Array.from(modal.querySelectorAll(
            'input:not([disabled]), button:not([disabled]), select:not([disabled]), textarea:not([disabled]), [href]'
          )).filter(el => el.tabIndex !== -1);
        };

        const setupModalFocusTrap = (modal) => {
          if (!modal) return;
          modal.addEventListener('keydown', (e) => {
            if (e.key !== 'Tab') return;
            const focusables = getModalFocusables(modal);
            if (!focusables.length) return;
            const idx = focusables.indexOf(document.activeElement);
            if (e.shiftKey) {
              if (idx <= 0) { focusables[focusables.length - 1].focus(); e.preventDefault(); }
            } else {
              if (idx === -1 || idx >= focusables.length - 1) { focusables[0].focus(); e.preventDefault(); }
            }
          });
        };

        const updateThemeIcons = (isDark) => {
          elements.iconMoon.classList.toggle('hidden', !isDark);
          elements.iconSun.classList.toggle('hidden', isDark);
        };

        const toggleTheme = () => {
          document.documentElement.classList.toggle('dark');
          const isDark = document.documentElement.classList.contains('dark');
          updateThemeIcons(isDark);
          const meta = document.querySelector('meta[name="theme-color"]');
          if (meta) meta.setAttribute('content', isDark ? '#0a0a0f' : '#f9fafb');
          LS.set('theme', isDark ? 'dark' : 'light');
        };

        const initTheme = () => {
          const isDark = LS.get('theme') !== 'light';
          document.documentElement.classList.toggle('dark', isDark);
          updateThemeIcons(isDark);
          const meta = document.querySelector('meta[name="theme-color"]');
          if (meta) meta.setAttribute('content', isDark ? '#0a0a0f' : '#f9fafb');
        };

        const updateClearButton = () => {
          elements.clear.classList.toggle('hidden', elements.searchInput.value.length === 0);
        };

        const handleClear = () => {
          elements.searchInput.value = '';
          elements.searchInput.focus();
          updateClearButton();
          elements.validateError.classList.add('hidden');
        };

        const getActiveFilterCount = () => {
          const v = getFilterValues();
          return ['type', 'tracker', 'voice', 'videotype', 'year', 'quality', 'season', 'refine', 'exclude'].filter(k => !!v[k]).length;
        };

        const updateFilterCountBadge = () => {
          const n = getActiveFilterCount();
          const badge = document.getElementById('filterCountBadge');
          const label = document.getElementById('filterToggleLabel');
          if (!badge || !label) return;
          badge.classList.toggle('hidden', n === 0);
          if (n > 0) {
            badge.textContent = String(n);
            label.setAttribute('aria-label', 'Дополнительные фильтры, активно ' + n);
          } else {
            label.removeAttribute('aria-label');
          }
        };

        const toggleFilters = () => {
          state.filtersVisible = !state.filtersVisible;
          elements.filterContainer.classList.toggle('show', state.filtersVisible);
          elements.filterContainer.setAttribute('aria-hidden', state.filtersVisible ? 'false' : 'true');
          if (elements.filterToggleIcon) elements.filterToggleIcon.style.transform = state.filtersVisible ? 'rotate(180deg)' : 'rotate(0deg)';
          if (elements.filterToggle) elements.filterToggle.setAttribute('aria-expanded', String(state.filtersVisible));
          LS.set('jacredFiltersOpen', state.filtersVisible ? '1' : '0');
        };

        const setResultsDisabled = (disabled) => {
          elements.resultsDiv.style.opacity = disabled ? '0.4' : '1';
          elements.resultsDiv.style.pointerEvents = disabled ? 'none' : 'auto';
        };

        const escapeHtml = (str) => {
          if (str == null) return '';
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        };

        const escapeAttr = (str) => {
          if (str == null) return '';
          return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        };

        const formatDate = (ts) => {
          if (ts == null) return '—';
          const d = new Date(ts);
          if (isNaN(d.getTime())) return '—';
          return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const getFilterValues = () => {
          const c = document.getElementById('filterContainer');
          if (!c) return { type: '', tracker: '', voice: '', videotype: '', year: '', quality: '', season: '', refine: '', exclude: '' };
          const get = (name) => { const el = c.querySelector('[name="' + name + '"]'); return el && el.value ? String(el.value).trim() : ''; };
          return { type: get('type'), tracker: get('tracker'), voice: get('voice'), videotype: get('videotype'), year: get('year'), quality: get('quality'), season: get('season'), refine: get('refine'), exclude: get('exclude') };
        };

        const getCurrentTrackerFilter = () => getFilterValues().tracker;

        const buildCardHtml = (elem, activeTracker) => {
          const title = escapeHtml(elem.title || elem.name || '');
          const url = elem.url ? escapeAttr(elem.url) : '#';
          const magnetAttr = escapeAttr(elem.magnet || '') || '#';
          const sizeName = escapeHtml(elem.sizeName || '—');
          const dateStr = formatDate(elem.createTime);
          const updateDateStr = elem.updateTime ? formatDate(elem.updateTime) : null;
          const sid = elem.sid != null ? elem.sid : 0;
          const pir = elem.pir != null ? elem.pir : 0;
          const tracker = (elem.tracker || '').toLowerCase();
          const icoSrc = `./img/ico/${tracker}.ico`;
          const trackerName = elem.tracker || '';
          const isActive = activeTracker && trackerName === activeTracker;
          const trackerBtnClass = isActive
            ? 'bg-blue-100 dark:bg-blue-900/50 border-blue-400 dark:border-blue-600 text-blue-800 dark:text-blue-200 ring-2 ring-blue-400 dark:ring-blue-500'
            : 'bg-gray-100 dark:bg-gray-800 hover:bg-blue-100 dark:hover:bg-blue-900/40 border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-700 text-gray-700 dark:text-gray-300 hover:text-blue-700 dark:hover:text-blue-300';
          const showUpdate = updateDateStr && updateDateStr !== dateStr;
          const updateMobileBadge = showUpdate ? `<span class="flex items-center gap-1.5"><svg class="w-4 h-4 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span class="font-semibold text-orange-600 dark:text-orange-400" title="Дата обновления">${updateDateStr}</span></span>` : '';
          const updateDesktopBadge = showUpdate ? `<span class="flex items-center gap-1.5"><svg class="w-3.5 h-3.5 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><span class="font-semibold text-orange-600 dark:text-orange-400" title="Дата обновления">${updateDateStr}</span></span>` : '';

          return `<div class="webResult mb-3 sm:mb-4">
  <div class="bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-800 overflow-hidden hover:border-gray-300 dark:hover:border-gray-700 transition-all shadow shadow-gray-200/50 dark:shadow-black/20">
    <div class="h2 flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 px-3 sm:px-4 py-2.5 sm:py-3 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
        <button type="button" class="btn-filter-tracker tap-target flex items-center justify-center w-8 h-8 rounded-md border flex-shrink-0 transition-all ${trackerBtnClass}" data-tracker="${escapeAttr(trackerName)}" title="${isActive ? 'Сбросить фильтр по трекеру' : 'Искать только на этом трекере'}" aria-label="Фильтр по трекеру ${escapeHtml(trackerName)}">
          <img src="${icoSrc}" alt="" class="w-4 h-4 object-contain" loading="lazy" onerror="this.style.display='none'">
        </button>
        <a href="${url}" target="_blank" rel="noopener noreferrer" class="text-sm sm:text-base font-semibold text-gray-900 dark:text-gray-100 hover:text-blue-600 dark:hover:text-blue-400 transition-colors break-words min-w-0 line-clamp-2 sm:line-clamp-1">${title}</a>
      </div>
      <div class="flex flex-row gap-2 flex-shrink-0">
        <a href="${magnetAttr}" rel="noopener noreferrer" class="magneto tap-target flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-b from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white" title="Открыть в торрент-клиенте" aria-label="Открыть магнит">
          <svg class="w-4 h-4 sm:w-5 sm:h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
        </a>
        <button type="button" class="btn-copy-magnet tap-target flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-amber-500 dark:hover:bg-amber-500/90 text-gray-600 dark:text-gray-400 hover:text-white active:bg-amber-600" data-magnet="${magnetAttr}" title="Копировать магнит-ссылку" aria-label="Копировать магнит">
          <i class="far fa-copy text-sm sm:text-base"></i>
        </button>
        <button type="button" class="btn-copy-hash tap-target flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-emerald-500 dark:hover:bg-emerald-500/90 text-gray-600 dark:text-gray-400 hover:text-white active:bg-emerald-600" data-magnet="${magnetAttr}" title="Копировать хеш торрента" aria-label="Копировать хеш">
          <svg class="w-4 h-4 sm:w-[18px] sm:h-[18px] shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
        </button>
        <button type="button" class="btn-send-to-tor tap-target flex items-center justify-center w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-violet-500 dark:hover:bg-violet-500/90 text-gray-600 dark:text-gray-400 hover:text-white active:bg-violet-600" data-magnet="${magnetAttr}" title="Отправить на TorrServer" aria-label="Отправить на TorrServer">
          <svg class="w-4 h-4 sm:w-5 sm:h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>
        </button>
      </div>
    </div>
    <div class="px-3 sm:px-4 py-2 sm:py-3">
      <div class="flex flex-col gap-2.5 sm:hidden text-xs text-gray-600 dark:text-gray-400">
        <div class="flex flex-wrap items-center gap-2.5">
          <span class="flex items-center gap-1.5 flex-shrink-0">
            <img src="${icoSrc}" alt="" class="w-4 h-4 object-contain" loading="lazy" onerror="this.style.display='none'">
            <span class="font-semibold text-gray-700 dark:text-gray-300">${escapeHtml(trackerName)}</span>
          </span>
          <span class="flex items-center gap-1.5">
            <svg class="w-4 h-4 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            <span class="font-semibold text-cyan-600 dark:text-cyan-400">${sizeName}</span>
          </span>
          <span class="flex items-center gap-1.5">
            <svg class="w-4 h-4 text-green-500 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
            <span class="font-bold text-green-600 dark:text-green-400">${sid}</span>
          </span>
          <span class="flex items-center gap-1.5">
            <svg class="w-4 h-4 text-red-500 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
            <span class="font-bold text-red-600 dark:text-red-400">${pir}</span>
          </span>
        </div>
        <div class="flex flex-wrap items-center gap-2.5">
          <span class="flex items-center gap-1.5">
            <svg class="w-4 h-4 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span class="font-semibold text-purple-600 dark:text-purple-400" title="Дата создания">${dateStr}</span>
          </span>
          ${updateMobileBadge}
        </div>
      </div>
      <div class="hidden sm:flex sm:flex-wrap sm:items-center sm:gap-3 md:gap-4 text-xs sm:text-sm text-gray-600 dark:text-gray-400">
        <span class="flex items-center gap-1.5 flex-shrink-0">
          <img src="${icoSrc}" alt="" class="w-3.5 h-3.5 object-contain" loading="lazy" onerror="this.style.display='none'">
          <span class="font-semibold text-gray-700 dark:text-gray-300">${escapeHtml(trackerName)}</span>
        </span>
        <span class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
          <span class="font-semibold text-cyan-600 dark:text-cyan-400">${sizeName}</span>
        </span>
        <span class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-green-500 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
          <span class="font-bold text-green-600 dark:text-green-400">${sid}</span>
        </span>
        <span class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-red-500 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
          <span class="font-bold text-red-600 dark:text-red-400">${pir}</span>
        </span>
        <span class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          <span class="font-semibold text-purple-600 dark:text-purple-400" title="Дата создания">${dateStr}</span>
        </span>
        ${updateDesktopBadge}
      </div>
    </div>
  </div>
</div>`;
        };

        const getHelpHtml = () => { const t = document.getElementById('helpTemplate'); return t ? t.innerHTML : ''; };
        const getNotFoundHtml = () => { const t = document.getElementById('notfoundTemplate'); return t ? t.innerHTML : ''; };

        const clearSearchStorage = () => {
          LS.remove('search');
          LS.remove('sort');
          LS.remove('exact');
          elements.searchInput.value = '';
          const sidRadio = document.querySelector('input[type=radio][name=sort][value=sid]');
          if (sidRadio) sidRadio.checked = true;
          if (elements.forcedSearch) elements.forcedSearch.checked = false;
          elements.resultsDiv.innerHTML = getHelpHtml();
          state.allItems = [];
          state.filteredItems = [];
          state.displayCount = 0;
          state.currentQuery = '';
          updateClearButton();
          updateFilterCountBadge();
        };

        const buildResultsFromJson = (items, limit) => {
          if (!Array.isArray(items)) return { html: getHelpHtml() };
          if (!items.length) return { html: getNotFoundHtml() };
          const show = limit ? items.slice(0, limit) : items;
          const activeTracker = getCurrentTrackerFilter();
          return { html: show.map(e => buildCardHtml(e, activeTracker)).join('') };
        };

        const buildApiUrl = (query) => {
          const sortVal = (document.querySelector('input[name="sort"]:checked') || {}).value || 'sid';
          const sortMap = { sid: 'sid', size: 'size', date: 'create', update: 'update' };
          const forcedSearch = elements.forcedSearch && elements.forcedSearch.checked;
          let url = API_BASE + '/torrents?search=' + encodeURIComponent(query) + '&sort=' + (sortMap[sortVal] || 'sid');
          if (forcedSearch) url += '&exact=true';
          const f = getFilterValues();
          if (f.type) url += '&type=' + encodeURIComponent(f.type);
          if (f.tracker) url += '&tracker=' + encodeURIComponent(f.tracker);
          if (f.voice) url += '&voice=' + encodeURIComponent(f.voice);
          if (f.videotype) url += '&videotype=' + encodeURIComponent(f.videotype);
          if (f.year) url += '&relased=' + encodeURIComponent(f.year);
          if (f.quality) url += '&quality=' + encodeURIComponent(f.quality);
          if (f.season) url += '&season=' + encodeURIComponent(f.season);
          const apiKey = LS.get('api_key');
          if (apiKey) url += '&apikey=' + encodeURIComponent(apiKey);
          return url;
        };

        const initFilter = (items) => {
          const container = document.getElementById('filterContainer');
          if (!container || !items || !items.length) return;
          const quality = new Set(), years = new Set(), trackers = new Set(), voices = new Set(), seasons = new Set(), types = new Set();
          items.forEach(el => {
            if (el.quality) quality.add(el.quality);
            if (el.relased) years.add(el.relased);
            if (el.tracker) trackers.add(el.tracker);
            if (el.voices) el.voices.forEach(v => voices.add(v));
            if (el.seasons) el.seasons.forEach(s => seasons.add(s));
            if (el.types) el.types.forEach(t => types.add(t));
          });
          const fillSelect = (name, values) => {
            const sel = container.querySelector('[name="' + name + '"]');
            if (!sel) return;
            const current = (sel.value || '').trim();
            if (current) values.add(current);
            sel.querySelectorAll('option:not([value=""])').forEach(o => o.remove());
            Array.from(values).sort().forEach(v => {
              const opt = document.createElement('option');
              opt.value = v;
              opt.textContent = v;
              sel.appendChild(opt);
            });
            if (current) sel.value = current;
          };
          fillSelect('quality', quality);
          fillSelect('year', years);
          fillSelect('tracker', trackers);
          fillSelect('voice', voices);
          fillSelect('season', seasons);
          fillSelect('type', types);
        };

        const applyClientFilters = (items) => {
          const refine = state.filterRefine;
          const exclude = state.filterExclude;
          if (!refine && !exclude) return items;
          return items.filter(el => {
            const title = (el.title || el.name || '').toLowerCase();
            if (refine && !title.includes(refine)) return false;
            if (exclude && title.includes(exclude)) return false;
            return true;
          });
        };

        const ensureApiKey = () => new Promise((resolve, reject) => {
          const key = LS.get('api_key');
          const url = API_BASE + '/conf' + (key ? '?apikey=' + encodeURIComponent(key) : '');
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), CONF_TIMEOUT_MS);
          fetch(url, { signal: controller.signal })
            .then(r => r.json())
            .then(json => {
              clearTimeout(timeoutId);
              if (json.apikey) {
                if (key) LS.set('api_key', key);
                resolve();
              } else if (key) {
                elements.validateError.textContent = 'API ключ неверный. Введите правильный ключ.';
                elements.validateError.classList.remove('hidden');
                reject(new Error('Неверный API ключ'));
              } else {
                const modal = document.getElementById('apiKeyModal');
                if (modal && modal.classList.contains('hidden')) document.getElementById('apiKeyBtn').click();
                reject(new Error('Требуется API ключ'));
              }
            })
            .catch(err => {
              clearTimeout(timeoutId);
              reject(new Error(err.name === 'AbortError' ? 'Истекло время ожидания ответа сервера' : 'Ошибка проверки API ключа'));
            });
        });

        const setSearchLoading = (loading) => {
          state.isLoading = loading;
          elements.loading.classList.toggle('hidden', !loading);
          elements.submitButton.disabled = loading;
          elements.submitButtonText.textContent = loading ? 'ПОИСК...' : 'ИСКАТЬ';
          setResultsDisabled(loading);
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          const query = elements.searchInput.value.trim();
          if (!query) {
            elements.validateError.textContent = 'Поисковый запрос пустой!';
            elements.validateError.classList.remove('hidden');
            return;
          }
          if (state.isLoading) return;
          LS.set('search', query);
          setSearchLoading(true);
          elements.validateError.classList.add('hidden');
          try {
            await ensureApiKey();
          } catch (err) {
            elements.validateError.textContent = err.message || 'Требуется ключ API';
            elements.validateError.classList.remove('hidden');
            setSearchLoading(false);
            return;
          }
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);
            const response = await fetch(buildApiUrl(query), { signal: controller.signal });
            clearTimeout(timeoutId);
            if (response.status === 401) {
              elements.validateError.textContent = 'Требуется API ключ. Проверьте введённый ключ.';
              elements.validateError.classList.remove('hidden');
              elements.resultsDiv.innerHTML = getNotFoundHtml();
              return;
            }
            if (response.status === 403) {
              elements.validateError.textContent = 'Доступ запрещён (403). Проверьте ключ API.';
              elements.validateError.classList.remove('hidden');
              elements.resultsDiv.innerHTML = getNotFoundHtml();
              return;
            }
            if (response.status === 429) {
              elements.validateError.textContent = 'Слишком много запросов. Подождите несколько секунд.';
              elements.validateError.classList.remove('hidden');
              elements.resultsDiv.innerHTML = getNotFoundHtml();
              return;
            }
            if (!response.ok) throw new Error('HTTP ' + response.status);
            const items = await response.json();
            state.allItems = Array.isArray(items) ? items : [];
            state.currentQuery = query;
            const f = getFilterValues();
            state.filterRefine = f.refine.toLowerCase();
            state.filterExclude = f.exclude.toLowerCase();
            initFilter(state.allItems);
            updateFilterCountBadge();
            state.filteredItems = applyClientFilters(state.allItems);
            state.displayCount = PAGE_SIZE;
            elements.resultsDiv.innerHTML = buildResultsFromJson(state.filteredItems, PAGE_SIZE).html;
            document.title = `Скачать торрент - ${query} | JacRed`;
            try { history.replaceState({}, document.title, '/'); } catch (_) { }
          } catch (error) {
            let msg = 'Ошибка выполнения поиска';
            if (error.name === 'AbortError') msg = 'Истекло время ожидания ответа. Попробуйте снова.';
            else if (error.message === 'Failed to fetch') msg = 'Ошибка сети. Проверьте соединение.';
            elements.validateError.textContent = msg;
            elements.validateError.classList.remove('hidden');
            elements.resultsDiv.innerHTML = getNotFoundHtml();
          } finally {
            setSearchLoading(false);
          }
        };

        const loadMore = () => {
          if (!state.filteredItems.length || state.displayCount >= state.filteredItems.length || state.isLoadingMore) return;
          state.isLoadingMore = true;
          const indicator = document.getElementById('loadMoreIndicator');
          if (indicator) indicator.classList.remove('hidden');
          setTimeout(() => {
            const start = state.displayCount;
            state.displayCount = Math.min(state.displayCount + PAGE_SIZE, state.filteredItems.length);
            const newItems = state.filteredItems.slice(start, state.displayCount);
            const activeTracker = getCurrentTrackerFilter();
            elements.resultsDiv.insertAdjacentHTML('beforeend', newItems.map(e => buildCardHtml(e, activeTracker)).join(''));
            state.isLoadingMore = false;
            if (indicator) indicator.classList.add('hidden');
          }, 300);
        };

        const extractInfoHash = (magnet) => {
          if (!magnet || typeof magnet !== 'string') return '';
          const m = magnet.match(/urn:btih:([a-fA-F0-9]{40}|[a-zA-Z2-7]{32}|[a-fA-F0-9]{64})/i);
          return m ? m[1].toLowerCase() : '';
        };

        const copyToClipboard = (text, btn, successHtml) => {
          if (!text || !btn) return;
          const write = () => {
            if (navigator.clipboard && navigator.clipboard.writeText) return navigator.clipboard.writeText(text);
            return new Promise((resolve, reject) => {
              const ta = document.createElement('textarea');
              ta.value = text;
              ta.style.cssText = 'position:fixed;opacity:0;top:0;left:0';
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              let ok = false;
              try { ok = document.execCommand('copy'); } finally { document.body.removeChild(ta); }
              ok ? resolve() : reject(new Error('copy failed'));
            });
          };
          write().then(() => {
            const old = btn.innerHTML;
            btn.innerHTML = successHtml || '<i class="fas fa-check text-green-600"></i>';
            setTimeout(() => { btn.innerHTML = old; }, 1500);
          }).catch(console.warn);
        };

        const handleScroll = debounce(() => {
          const scrolled = window.scrollY || document.documentElement.scrollTop;
          elements.backToTop.classList.toggle('opacity-0', scrolled <= 300);
          elements.backToTop.classList.toggle('pointer-events-none', scrolled <= 300);
          elements.backToTop.classList.toggle('opacity-100', scrolled > 300);
        }, 100);

        const torBtnDefaultHtml = '<svg class="w-4 h-4 sm:w-5 sm:h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>';
        const torBtnSpinnerHtml = '<span class="spinner inline-block w-4 h-4 sm:w-5 sm:h-5 border-2 border-current border-t-transparent rounded-full shrink-0" aria-hidden="true"></span>';
        const torBtnSuccessHtml = '<svg class="w-4 h-4 sm:w-5 sm:h-5 shrink-0 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>';

        let openTorServerModal;

        const init = () => {
          elements.searchForm = document.getElementById('searchForm');
          elements.searchInput = document.getElementById('s');
          elements.clear = document.getElementById('clear');
          elements.submitButton = document.getElementById('submitButton');
          elements.submitButtonText = document.getElementById('submitButtonText');
          elements.validateError = document.getElementById('validateError');
          elements.loading = document.getElementById('loading');
          elements.resultsDiv = document.getElementById('resultsDiv');
          elements.filterToggle = document.getElementById('filterToggle');
          elements.filterToggleIcon = document.getElementById('filterToggleIcon');
          elements.filterContainer = document.getElementById('filterContainer');
          elements.forcedSearch = document.getElementById('forcedSearch');
          elements.toggleTheme = document.getElementById('toggleTheme');
          elements.iconMoon = document.getElementById('iconMoon');
          elements.iconSun = document.getElementById('iconSun');
          elements.backToTop = document.getElementById('backToTop');

          elements.resultsDiv.innerHTML = getHelpHtml();

          window.addEventListener('unhandledrejection', (e) => console.error('Unhandled rejection:', e.reason));

          initTheme();

          elements.searchForm.addEventListener('submit', handleSubmit);
          elements.searchInput.addEventListener('input', () => { updateClearButton(); elements.validateError.classList.add('hidden'); });
          elements.clear.addEventListener('click', handleClear);
          elements.filterToggle.addEventListener('click', toggleFilters);

          if (LS.get('jacredFiltersOpen') === '1') {
            state.filtersVisible = true;
            elements.filterContainer.classList.add('show');
            elements.filterContainer.setAttribute('aria-hidden', 'false');
            if (elements.filterToggleIcon) elements.filterToggleIcon.style.transform = 'rotate(180deg)';
            if (elements.filterToggle) elements.filterToggle.setAttribute('aria-expanded', 'true');
          } else {
            elements.filterContainer.setAttribute('aria-hidden', 'true');
          }

          updateFilterCountBadge();
          elements.toggleTheme.addEventListener('click', toggleTheme);
          elements.backToTop.addEventListener('click', (e) => { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); });

          const clearSearchStorageBtn = document.getElementById('clearSearchStorage');
          if (clearSearchStorageBtn) clearSearchStorageBtn.addEventListener('click', clearSearchStorage);

          const apiKeyModal = document.getElementById('apiKeyModal');
          const apiKeyInput = document.getElementById('apiKeyInput');
          const apiKeyModalError = document.getElementById('apiKeyModalError');
          const apiKeyModalSave = document.getElementById('apiKeyModalSave');
          const apiKeyModalCancel = document.getElementById('apiKeyModalCancel');
          const apiKeyModalBackdrop = document.getElementById('apiKeyModalBackdrop');
          let apiKeyModalTrigger = null;

          setupModalFocusTrap(apiKeyModal);

          const openApiKeyModal = () => {
            if (!apiKeyModal || !apiKeyInput) return;
            apiKeyModalTrigger = document.getElementById('apiKeyBtn');
            apiKeyInput.value = LS.get('api_key');
            apiKeyModalError.classList.add('hidden');
            apiKeyModalError.textContent = '';
            apiKeyModal.classList.remove('hidden');
            setTimeout(() => { const f = getModalFocusables(apiKeyModal)[0]; if (f) f.focus(); else apiKeyInput.focus(); }, 50);
          };

          const closeApiKeyModal = () => {
            if (apiKeyModal) apiKeyModal.classList.add('hidden');
            if (apiKeyModalTrigger) { apiKeyModalTrigger.focus(); apiKeyModalTrigger = null; }
          };

          const saveApiKeyFromModal = () => {
            const key = (apiKeyInput.value || '').trim();
            if (!key) {
              if (apiKeyModalError) { apiKeyModalError.textContent = 'Введите ключ'; apiKeyModalError.classList.remove('hidden'); }
              return;
            }
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), CONF_TIMEOUT_MS);
            fetch(API_BASE + '/conf?apikey=' + encodeURIComponent(key), { signal: controller.signal })
              .then(r => r.json())
              .then(json => {
                clearTimeout(timeoutId);
                if (json.apikey) {
                  LS.set('api_key', key);
                  closeApiKeyModal();
                } else {
                  if (apiKeyModalError) { apiKeyModalError.textContent = 'Ключ неверный или не принят сервером'; apiKeyModalError.classList.remove('hidden'); }
                }
              })
              .catch(err => {
                clearTimeout(timeoutId);
                if (apiKeyModalError) {
                  apiKeyModalError.textContent = err.name === 'AbortError' ? 'Истекло время ожидания' : 'Ошибка проверки ключа';
                  apiKeyModalError.classList.remove('hidden');
                }
              });
          };

          document.getElementById('apiKeyBtn').addEventListener('click', openApiKeyModal);
          if (apiKeyModalCancel) apiKeyModalCancel.addEventListener('click', closeApiKeyModal);
          if (apiKeyModalBackdrop) apiKeyModalBackdrop.addEventListener('click', closeApiKeyModal);
          if (apiKeyModalSave) apiKeyModalSave.addEventListener('click', saveApiKeyFromModal);
          if (apiKeyInput) {
            apiKeyInput.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') { e.preventDefault(); saveApiKeyFromModal(); }
              else if (e.key === 'Escape') { e.preventDefault(); closeApiKeyModal(); }
            });
          }

          const torServerModal = document.getElementById('torServerModal');
          const torServerUrlInput = document.getElementById('torServerUrlInput');
          const torServerLoginInput = document.getElementById('torServerLoginInput');
          const torServerPasswordInput = document.getElementById('torServerPasswordInput');
          const torServerModalError = document.getElementById('torServerModalError');
          const torServerModalSave = document.getElementById('torServerModalSave');
          const torServerModalCancel = document.getElementById('torServerModalCancel');
          const torServerModalBackdrop = document.getElementById('torServerModalBackdrop');
          let torServerModalTrigger = null;

          setupModalFocusTrap(torServerModal);

          openTorServerModal = () => {
            if (!torServerModal || !torServerUrlInput) return;
            torServerModalTrigger = document.getElementById('torServerBtn');
            torServerUrlInput.value = LS.get('jacredTorServerUrl');
            if (torServerLoginInput) torServerLoginInput.value = LS.get('jacredTorServerLogin');
            if (torServerPasswordInput) torServerPasswordInput.value = LS.get('jacredTorServerPassword');
            torServerModalError.classList.add('hidden');
            torServerModalError.textContent = '';
            torServerModal.classList.remove('hidden');
            setTimeout(() => { const f = getModalFocusables(torServerModal)[0]; if (f) f.focus(); else torServerUrlInput.focus(); }, 50);
          };

          const closeTorServerModal = () => {
            if (torServerModal) torServerModal.classList.add('hidden');
            if (torServerModalTrigger) { torServerModalTrigger.focus(); torServerModalTrigger = null; }
          };

          const saveTorServerFromModal = () => {
            const url = torServerUrlInput ? torServerUrlInput.value.trim() : '';
            const login = torServerLoginInput ? torServerLoginInput.value.trim() : '';
            const password = torServerPasswordInput ? torServerPasswordInput.value : '';
            if (!url) {
              if (torServerModalError) { torServerModalError.textContent = 'Введите URL сервера'; torServerModalError.classList.remove('hidden'); }
              return;
            }
            try { new URL(url); } catch (_) {
              if (torServerModalError) { torServerModalError.textContent = 'Некорректный URL'; torServerModalError.classList.remove('hidden'); }
              return;
            }
            LS.set('jacredTorServerUrl', url);
            LS.set('jacredTorServerLogin', login);
            LS.set('jacredTorServerPassword', password);
            if (torServerModalError) { torServerModalError.classList.add('hidden'); torServerModalError.textContent = ''; }
            closeTorServerModal();
          };

          document.getElementById('torServerBtn').addEventListener('click', openTorServerModal);
          if (torServerModalCancel) torServerModalCancel.addEventListener('click', closeTorServerModal);
          if (torServerModalBackdrop) torServerModalBackdrop.addEventListener('click', closeTorServerModal);
          if (torServerModalSave) torServerModalSave.addEventListener('click', saveTorServerFromModal);

          [torServerUrlInput, torServerLoginInput, torServerPasswordInput].forEach(input => {
            if (!input) return;
            input.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') { e.preventDefault(); saveTorServerFromModal(); }
              else if (e.key === 'Escape') { e.preventDefault(); closeTorServerModal(); }
            });
          });

          document.addEventListener('keydown', (e) => {
            if (e.key !== 'Escape') return;
            if (apiKeyModal && !apiKeyModal.classList.contains('hidden')) { e.preventDefault(); closeApiKeyModal(); }
            else if (torServerModal && !torServerModal.classList.contains('hidden')) { e.preventDefault(); closeTorServerModal(); }
          });

          const loadMoreSentinel = document.getElementById('loadMoreSentinel');
          if (loadMoreSentinel && 'IntersectionObserver' in window) {
            new IntersectionObserver((entries) => {
              entries.forEach(entry => {
                if (entry.isIntersecting && state.filteredItems.length && state.displayCount < state.filteredItems.length && !state.isLoadingMore && !state.isLoading) loadMore();
              });
            }, { rootMargin: '500px', threshold: 0 }).observe(loadMoreSentinel);
          }

          document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-copy-magnet');
            if (!btn) return;
            e.preventDefault();
            e.stopPropagation();
            copyToClipboard(btn.getAttribute('data-magnet'), btn, '<i class="fas fa-check text-green-600"></i>');
          });

          document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-copy-hash');
            if (!btn) return;
            e.preventDefault();
            e.stopPropagation();
            const hash = extractInfoHash(btn.getAttribute('data-magnet'));
            if (hash) copyToClipboard(hash, btn, '<i class="fas fa-check text-green-600 text-sm"></i>');
          });

          document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.btn-send-to-tor');
            if (!btn) return;
            e.preventDefault();
            e.stopPropagation();
            if (btn.disabled || btn.classList.contains('is-loading')) return;
            const magnet = btn.getAttribute('data-magnet');
            if (!magnet) return;
            const baseUrl = LS.get('jacredTorServerUrl').trim();
            if (!baseUrl) { openTorServerModal(); return; }
            const login = LS.get('jacredTorServerLogin').trim();
            const password = LS.get('jacredTorServerPassword').trim();
            const origTitle = btn.getAttribute('title');

            const setFeedback = (msg) => { btn.setAttribute('title', msg); setTimeout(() => btn.setAttribute('title', origTitle), 3000); };
            const setButtonState = (btnState) => {
              if (btnState === 'loading') {
                btn.disabled = true;
                btn.classList.add('pointer-events-none', 'is-loading');
                btn.setAttribute('aria-busy', 'true');
                btn.setAttribute('title', 'Отправка…');
                btn.innerHTML = torBtnSpinnerHtml;
              } else if (btnState === 'success') {
                btn.disabled = false;
                btn.classList.remove('pointer-events-none', 'is-loading');
                btn.setAttribute('aria-busy', 'false');
                btn.classList.add('is-sent');
                btn.innerHTML = torBtnSuccessHtml;
                setTimeout(() => { btn.classList.remove('is-sent'); btn.innerHTML = torBtnDefaultHtml; btn.setAttribute('title', origTitle); }, 1800);
              } else {
                btn.disabled = false;
                btn.classList.remove('pointer-events-none', 'is-loading');
                btn.setAttribute('aria-busy', 'false');
                btn.innerHTML = torBtnDefaultHtml;
              }
            };

            setButtonState('loading');
            let torUrl = baseUrl.replace(/\/$/, '') + '/torrents';
            let authHeader = null;
            try {
              const urlObj = new URL(baseUrl);
              if (urlObj.username || urlObj.password) {
                authHeader = 'Basic ' + btoa(decodeURIComponent(urlObj.username || '') + ':' + decodeURIComponent(urlObj.password || ''));
                torUrl = urlObj.origin.replace(/\/$/, '') + (urlObj.pathname === '/' ? '' : urlObj.pathname.replace(/\/$/, '')) + '/torrents';
              }
            } catch (_) { }
            if (!authHeader && login && password) authHeader = 'Basic ' + btoa(login + ':' + password);
            const headers = { 'Content-Type': 'application/json' };
            if (authHeader) headers['Authorization'] = authHeader;
            try {
              const res = await fetch(torUrl, { method: 'POST', headers, body: JSON.stringify({ action: 'add', link: magnet, save_to_db: true }) });
              if (res.ok) {
                setFeedback('Торрент отправлен на TorrServer');
                setButtonState('success');
              } else {
                const text = await res.text().catch(() => '');
                if (res.status === 401) setFeedback('Ошибка авторизации: проверьте логин и пароль');
                else if (res.status === 403) setFeedback('CORS: разрешите запросы с этого сайта в настройках TorrServer');
                else setFeedback('Ошибка ' + res.status + (text ? ': ' + text.slice(0, 80) : ''));
                setButtonState('idle');
              }
            } catch (err) {
              setFeedback(err.message || 'Ошибка сети. Проверьте URL и CORS.');
              setButtonState('idle');
            }
          });

          document.addEventListener('click', (e) => {
            const trackerBtn = e.target.closest('.btn-filter-tracker');
            if (!trackerBtn) return;
            e.preventDefault();
            e.stopPropagation();
            const tracker = (trackerBtn.getAttribute('data-tracker') || '').trim();
            const sel = document.querySelector('#filterContainer select[name="tracker"]');
            if (!sel) return;
            const current = (sel.value || '').trim();
            const isSame = current && tracker && current.toLowerCase() === tracker.toLowerCase();
            if (isSame) {
              sel.value = '';
            } else {
              const opt = Array.from(sel.options).find(o => o.value.trim().toLowerCase() === tracker.toLowerCase());
              sel.value = opt ? opt.value : '';
            }
            updateFilterCountBadge();
            if (elements.searchInput.value.trim()) elements.searchForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
          });

          const applyRefineExclude = () => {
            const f = getFilterValues();
            state.filterRefine = f.refine.toLowerCase();
            state.filterExclude = f.exclude.toLowerCase();
            updateFilterCountBadge();
            if (!state.allItems.length) return;
            state.filteredItems = applyClientFilters(state.allItems);
            state.displayCount = PAGE_SIZE;
            elements.resultsDiv.innerHTML = buildResultsFromJson(state.filteredItems, PAGE_SIZE).html;
          };

          const fc = document.getElementById('filterContainer');
          if (fc) {
            fc.querySelectorAll('[name="refine"], [name="exclude"]').forEach(el => el.addEventListener('input', debounce(applyRefineExclude, 200)));
            fc.querySelectorAll('select.filter-input').forEach(sel => {
              sel.addEventListener('change', () => {
                updateFilterCountBadge();
                if (elements.searchInput.value.trim()) elements.searchForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
              });
            });
          }

          const resetBtn = document.getElementById('filterReset');
          if (resetBtn) {
            resetBtn.addEventListener('click', () => {
              const fc2 = document.getElementById('filterContainer');
              if (fc2) {
                fc2.querySelectorAll('[name="refine"], [name="exclude"]').forEach(el => { el.value = ''; });
                fc2.querySelectorAll('select.filter-input').forEach(sel => { sel.selectedIndex = 0; });
              }
              state.filterRefine = '';
              state.filterExclude = '';
              updateFilterCountBadge();
              if (elements.searchInput.value.trim()) elements.searchForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
            });
          }

          document.querySelectorAll('input[type=radio][name=sort]').forEach(radio => {
            radio.addEventListener('change', function () {
              LS.set('sort', this.value);
              if (elements.searchInput.value.trim()) elements.searchForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
            });
          });

          if (elements.forcedSearch) {
            elements.forcedSearch.addEventListener('change', function () {
              LS.set('exact', this.checked ? '1' : '0');
              if (elements.searchInput.value.trim()) elements.searchForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
            });
          }

          window.addEventListener('scroll', handleScroll, { passive: true });
          updateClearButton();

          const savedSort = LS.get('sort');
          if (savedSort) {
            const radio = document.querySelector('input[type=radio][name=sort][value="' + savedSort + '"]');
            if (radio) radio.checked = true;
          }
          if (LS.get('exact') === '1' && elements.forcedSearch) elements.forcedSearch.checked = true;

          const savedSearch = LS.get('search').trim();
          if (savedSearch) {
            elements.searchInput.value = savedSearch;
            updateClearButton();
            elements.searchForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
          }
        };

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
        else init();
      })();
  </script>
</body>

</html>
